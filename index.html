<!doctype>
<html>

<head>
    <title>abi2html</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="./dist/bignumber.min.js"></script>
    <script type="text/javascript" src="./dist/web3-light.min.js"></script>
    <script type="text/javascript" src="./lib/abi2html.js"></script>
    <script type="text/javascript" src="./lib/util.js"></script>
    <script type="text/javascript" src="./lib/uiComponents.js"></script>
    <script type="text/javascript">
    var loadedAbiHtml = []
    var selectedDocIndex
    var web3 = (typeof web3 === 'undefined' ? new Web3() : web3)
    var blockFilter
    var appStatus = new AppStatus()

    window.onload = function() {
        var gistId = getParameterByName('GIST_ID')
        var address = getParameterByName('ADDRESS')
        var providerString = ''

        // set defaults for friendliness
        if (!gistId) {
            if (window.location.protocol === "file:") {
                // debug
                // gistId = "505534d5a37ffa3a0625"
                gistId = "0e1b884de82d35053a34"
                address = "0x63f33b08404987648ce2dde79715e14e8b69e4d8"
                providerString = 'http://127.0.0.1:8545'
            } else if (window.location.host === 'tgerring.github.io') {
                // public
                gistId = "0e1b884de82d35053a34"
                address = "0xde0b295669a9fd93d5f28d9ec85e40f4cb697bae"
            }
        }

        var toAddress = document.getElementById('option-address')
        if (toAddress && address) toAddress.value = address

        // preload resources
        if (gistId) {
            callAjax('https://api.github.com/gists/' + gistId, function(response) {
                if (response != null) {
                  var result = JSON.parse(response)
                  if (result) {
                      var i = 0
                      for (var filename in result.files) {
                          var ah = new AbiHtml(result.files[filename].content)
                          ah.name = filename
                          loadedAbiHtml[i] = ah
                          i++
                      }
                  }
                }
            })
        } else {
            document.getElementById('main').classList.add('flip')
        }

                // render code
                selectedDocIndex = 0
                displayCode(selectedDocIndex)
                displayUi(selectedDocIndex)

                var connected = connectInstance(providerString)
                if (connected) {
                    watchBlocks(false)

                    var address = document.getElementById('option-address').value
                    watchEvents(address)
                }

                routeApp()



        setHandlers()
        connectInstance()
    }


    var watchEvents = function(address) {
      var ah = loadedAbiHtml[selectedDocIndex]
      if (!ah) return
      ah.WatchAllEvents({
        address: address,
        fromBlock: 'latest',
        toBlock: 'latest'
      }, null, function(evmEvent) {
        var link = evmEvent.name + '/' + evmEvent.result.blockNumber + '/' + evmEvent.result.transactionIndex + '/' + evmEvent.result.logIndex
        var foo = '<a href="#' + link + '">' + evmEvent.name + '</a>'
        displayBlock(evmEvent.result.blockNumber, foo, 'success')
      })
      var el = document.getElementById('notification-anchor').querySelector('.notification')
    }

    var watchBlocks = function(displayAll) {
      if (blockFilter) blockFilter.stopWatching()

      // display inital state
      var block = web3.eth.getBlock('pending')
      var el = document.getElementById('notification-anchor')
      el.children[0].innerHTML  = 'Pending block #' + block.number + '<br>'
      el.children[0].innerHTML += 'Gas limit: ' + block.gasLimit + '<hr>'
      el.children[0].innerHTML += '<ul id="pending-tx"></ul>'
      el.children[0].classList.add('dashed')

      // create filter for new blocks
      var filter = web3.eth.filter('latest')
      filter.watch(function(err, hash) {
        // get new block
        var latest = web3.eth.getBlock(hash)
        // loop through transactions
        for (var i = 0; i < latest.transactions.length; i++) {
            // get transaction hash
          var txhash = latest.transactions[i]
          if (appStatus.isTransactionPending(txhash)) {
            // if the block transaction is in the local cache
            var foo = txhash.substring(0, 8) + '...' + txhash.substring(txhash.length - 6)
            var link = 'tx/' + txhash
            var msg = '<a href="#' + link + '">' + foo + '</a>'
            displayBlock(latest.number, msg, 'success')
            // remove the transaction 
            appStatus.removeTransaction(txhash)
          }
        }

        var block = web3.eth.getBlock('pending')
        var el = document.getElementById('notification-anchor')
        el.children[0].innerHTML  = 'Pending block #' + block.number + '<br>'
        el.children[0].innerHTML += 'Gas limit: ' + block.gasLimit + '<hr>'
        el.children[0].innerHTML += '<ul id="pending-tx"></ul>'
        el.children[0].classList.add('dashed')

        appStatus.displayPending()
      })

      blockFilter = filter
    }
    </script>
</head>

<body>
    <div id="modalwrapper">
        <div id="modal">
        </div>
    </div>
    <div class="page-wrap">
        <div id="main" class="flip-container full-size">
            <div class="flipper">
                <div id="uiview" class="front">
                    <div class="header">
                        <div class="wrapper nowrap">
                            <div>
                                <div id="notifications" class="notifications nowrap">
                                </div>
                            </div>
                            <div id="notification-anchor">
                                <div class="notification">Not connected</div>
                                <div class="inline">
                                    <input type="button" id="btnSend" value="Send">
                                    <input type="button" onclick="document.getElementById('main').classList.toggle('flip');" value="Code">
                                    <input type="button" value="Update" id="btnWatch" class="stack">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="main">
                        <div class="wrapper">
                            <div id="functions">
                                <div>
                                    <h2>Functions</h2>
                                    <label for="option-from">Account:</label>
                                    <select id="option-from" disabled>
                                        <option>Not connected</option>
                                    </select>
                                    <div>
                                        <div id="tab-container">
                                            <ul>
                                            </ul>
                                        </div>
                                        <div id="main-container">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="logs">
                                <div>
                                    <h2>Events</h2>
                                    <label for="option-address">Watch address:</label>
                                    <input type="text" id="option-address" class="solfield address" placeholder="0x" disabled>
                                    <div id="log-search"></div>
                                    <div id="message-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="codeview" class="back">
                    <div class="header">
                        <div class="wrapper">
                            <nav id="docnav">
                            </nav>
                            <div>
                                <input type="button" id="btnDeploy" value="Deploy">
                                <input type="button" id="btnSave" value="Save">
                                <input type="button" id="btnViewInterface" value="UI">
                            </div>
                        </div>
                    </div>
                    <div class="main">
                        <div class="wrapper">
                            <div id="contract">
                                <div>
                                    <textarea placeholder="contract" id="source-code"></textarea>
                                </div>
                            </div>
                            <div id="abi">
                                <div>
                                    <div id="abi-tree"></div>
                                    <textarea placeholder="abi" id="abi-code"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
